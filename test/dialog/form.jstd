travi.test.testCase('dialog forms', (function () {
    'use strict';

    var dialogForm = travi.ui.dialog.form,
        dialogEvents = travi.ui.dialog.events,
        dialog = travi.ui.dialog.simple,
        validationMapper = travi.ui.form.validationMapper,

        testEvents = travi.test.events,
        any = travi.test.any,

        ajaxCallbacks = {},

        formAction = any.string(),
        formMethod = any.string(),
        fieldName = any.string(),
        fieldValue = any.string(),
        $content = $('<section><form method="' + formMethod + '" action="' + formAction + '"><input name="' + fieldName + '" value="' + fieldValue + '"></input></form></section>'),
        addedEntityUrl = any.string(),
        addedEntitySuccess;

    function launchDialogAndSubmitForm() {
        testEvents.publish(dialogEvents.keys.LOADED, {
            dialog: $content.get(0)
        });
        $('form').submit();
        $.ajax.reset();
    }

    return {
        setUp: function () {
            $('body').append($content);

            testEvents.stub();
            sinon.stub($, 'ajax', function (options) {
                if (options.url === formAction) {
                    ajaxCallbacks.success = options.success;
                    ajaxCallbacks.badRequest = options.statusCode[400];
                    ajaxCallbacks.added = options.statusCode[201];
                } else if (options.url === addedEntityUrl) {
                    addedEntitySuccess = options.success;
                }
            });
            sinon.stub(dialog, 'close');

            dialogForm.init();
        },

        tearDown: function () {
            travi.test.common.restore([
                $.ajax,
                dialog.close,
                validationMapper.showErrors
            ]);
            testEvents.restore();
        },

        'test submitting form from dialog content triggers ajax request': function () {
            testEvents.publish(dialogEvents.keys.LOADED, {
                dialog: $content.get(0)
            });

            $('form').submit();

            assert.calledWith($.ajax, sinon.match({
                url: formAction,
                type: formMethod,
                dataType: 'json',
                data: fieldName + '=' + fieldValue
            }));
        },

        'test that form submission defaults to GET if not specified': function () {
            var $formNoMethod = $('<section><form action="' + formAction + '"></form></section>');
            $('body').html($formNoMethod);
            testEvents.publish(dialogEvents.keys.LOADED, {
                dialog: $formNoMethod.get(0)
            });

            $('form').submit();

            assert.calledWith($.ajax, sinon.match({
                type: 'get'
            }));
        },

        'test that dialog is closed after successful form submission': function () {
            testEvents.publish(dialogEvents.keys.LOADED, {
                dialog: $content.get(0)
            });
            $('form').submit();

            ajaxCallbacks.success();

            assert.calledOnce(dialog.close);
        },

        'test that dialog is not closed after validation error and errors are shown on the form': function () {
            var $form = $('form'),
                validationErrors = {
                    foo: 'bar'
                };
            sinon.stub(validationMapper, 'showErrors');
            testEvents.publish(dialogEvents.keys.LOADED, {
                dialog: $content.get(0)
            });
            $form.submit();

            ajaxCallbacks.badRequest({
                errors: validationErrors
            });

            refute.called(dialog.close);
            assert.calledWith(validationMapper.showErrors, $form.get(0), validationErrors);
        },

        'test that details about added entity requested after successful addition': function () {
            var xhr = {
                getResponseHeader: function () {
                    return addedEntityUrl;
                }
            };
            sinon.spy(xhr, 'getResponseHeader');
            launchDialogAndSubmitForm();

            ajaxCallbacks.added(null, null, xhr);

            assert.calledWith(xhr.getResponseHeader, 'Location');
            assert.calledWith($.ajax, sinon.match({
                url: addedEntityUrl
            }));
        },

        'test that item added to entity list as result of 201': function () {
            $('body').append('<ol class="entityList"></ol>');
            launchDialogAndSubmitForm();

            ajaxCallbacks.added(null, null, {
                getResponseHeader: function () {
                    return addedEntityUrl;
                }
            });

            addedEntitySuccess();

            assert.equals($('ol.entityList li').length, 1);
        }
    };
}()));