travi.test.testCase('dialog forms', (function () {
    'use strict';

    var dialogForm = travi.ui.dialog.form,
        dialogEvents = travi.ui.dialog.events,

        testEvents = travi.test.events,
        any = travi.test.any,

        formAction = any.string(),
        formMethod = any.string(),
        $content = $('<section><form method="' + formMethod + '" action="' + formAction + '"></form></section>');

    return {
        setUp: function () {
            $('body').append($content);

            testEvents.stub();
            sinon.stub($, 'ajax');

            dialogForm.init();
        },

        tearDown: function () {
            travi.test.common.restore([$.ajax]);
            testEvents.restore();
        },

        'test submitting form from dialog content triggers ajax request': function () {
            testEvents.publish(dialogEvents.keys.LOADED, {
                $dialog: $content
            });

            $('form').submit();

            sinon.assert.calledWith($.ajax, {
                url: formAction,
                type: formMethod
            });
        },

        'test that form submission defaults to GET if not specified': function () {
            var $formNoMethod = $('<section><form action="' + formAction + '"></form></section>');
            $('body').html($formNoMethod);
            testEvents.publish(dialogEvents.keys.LOADED, {
                $dialog: $formNoMethod
            });

            $('form').submit();

            sinon.assert.calledWith($.ajax, sinon.match({
                type: 'get'
            }));
        }
    };
}()));