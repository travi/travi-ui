travi.test.testCase('EntityListTests', (function () {
    'use strict';

    return {
        common: travi.test.common,

        entityList: travi.ui.entityList.core,
        pagination: travi.ui.pagination,
        templates: travi.templates,
        events: travi.events,

        entities: [
            {
                type: 'someType',
                id: 43254,
                title: 'some title',
                details: [
                    'some detail'
                ]
            },
            {
                type: 'someOtherType',
                id: 43254,
                title: 'some other title',
                details: [
                    'some other detail'
                ]
            }
        ],

        setUp: function () {
            var testCase = this;

            $('body').append($.render.entityList({}));

            sinon.stub(this.events, 'subscribe', function (eventName, callback) {
                if (testCase.pagination.events.NEXT_PAGE_REQUESTED === eventName) {
                    testCase.nextPageCallback = callback;
                } else if (testCase.pagination.events.PREV_PAGE_REQUESTED === eventName) {
                    testCase.prevPageCallback = callback;
                }
            });

            this.entityList.init();

            this.$form = $('form');
            this.$confirmation = $('#confirmation');

            sinon.stub(this.templates, 'get', function () {
                var deferred = new $.Deferred();
                deferred.resolve();
                return deferred;
            });
        },

        tearDown: function () {
            travi.test.common.restore([
                jQuery.ajax,
                this.events.publish,
                this.events.subscribe,
                this.templates.get
            ]);

            this.$confirmation.dialog('destroy').remove();
        },

        'test events defined properly': function () {
            assert.equals('page-loaded', this.entityList.constants.get('PAGE_EVENT'));
        },

        'test confirmation ready for use': function () {
            assert.equals(this.$confirmation.length, 1);
            assert(this.$confirmation.is(':not(:visible)'));

            assert(this.$confirmation.dialog('option', 'modal'));
            refute(this.$confirmation.dialog('option', 'resizable'));
            refute(this.$confirmation.dialog('option', 'autoOpen'));
        },

        'test submitting "remove" form shows confirmation': function () {
            this.$form.submit();

            this.assertModalDialogIsShown();
        },

        'test form gets converted to link': function () {
            assert.equals(1, this.$form.length);
            assert(this.$form.is(':not(:visible)'));
            assert($("li.remove-item a.item-action.icon-remove").is(':visible'));
        },

        'test clicking link triggers submit event on corresponding form': function () {
            $('a.item-action').click();

            this.assertModalDialogIsShown();
        },

        'test confirming remove makes ajax POST and removes entity on success': function () {
            sinon.stub(jQuery, 'ajax', function (options) {
                options.success({});
            });
            assert.equals(1, $('.entityList>li').length);
            $('a.item-action').click();
            $('.ui-dialog-buttonpane button').eq(0).click();

            sinon.assert.calledOnce(jQuery.ajax);
            sinon.assert.calledWith($.ajax, sinon.match({
                type: 'post',
                dataType: 'json'
            }));
            assert($.ajax.getCall(0).args[0].url.indexOf('/admin/updates/45') !== -1);

            assert.equals(0, $('.entityList>li').length);
        },

        'test request for next page loads more announcements': function () {
            var url = 'nextUrl';
            this.stubRequestForAnnouncements();
            sinon.stub(this.events, 'publish');

            this.nextPageCallback({url: url});

            assert(jQuery.ajax.calledOnce);
            this.common.assertAjaxCallMadeWith({
                url: url,
                type: 'get',
                dataType: 'json'
            }, jQuery.ajax.getCall(0).args[0]);

            this.assertLoadedDataAddedToList();
        },

        'test request for prev page loads more announcements': function () {
            var url = 'prevUrl';
            this.stubRequestForAnnouncements();
            sinon.stub(this.events, 'publish');

            this.prevPageCallback({url: url});

            assert(jQuery.ajax.calledOnce);
            this.common.assertAjaxCallMadeWith({
                url: url,
                type: 'get',
                dataType: 'json'
            }, jQuery.ajax.getCall(0).args[0]);

            this.assertLoadedDataAddedToList();
        },

//    'test offset defaults to zero': function () {
//        var  url = 'prevUrl',
//            call,
//            testCase = this;
//        sinon.stub(travi, 'publish');
//
//        sinon.stub(jQuery, 'ajax', function (options) {
//            options.success.call(null, {
//                list: {
//                    list: {
//                        entities: testCase.entities,
//                        limit: 5
//                    }
//                }
//            });
//        });
//
//        amplify.publish(this.pagination.events.PREV_PAGE_REQUESTED, {url: url});
//
//        assert(jQuery.ajax.calledOnce);
//        this.assertAjaxCallMadeWith({
//            url: url,
//            method: 'get',
//            dataType: 'json'
//        }, jQuery.ajax.getCall(0).args[0]);
//
//        assert.equals(this.entities.length, $('.entityList > li').length);
//
//        assert(travi.publish.calledOnce);
//        call = travi.publish.getCall(0);
//        assert.equals(this.entityList.constants.get('PAGE_EVENT'), call.args[0]);
//        assert.equals(5, call.args[1].nextOffset);
//        assert.equals(-5, call.args[1].prevOffset);
//        assert.equals(0, call.args[1].offset);
//    },

        assertModalDialogIsShown: function () {
            assert(this.$confirmation.is(':visible'));
            assert.equals(1, $('.confirmation').length);
            assert.equals(1, $('div.ui-widget-overlay').length, 1);
        },

        assertLoadedDataAddedToList: function () {
            assert.equals(this.entities.length, $('.entityList > li').length);
            assert.equals(this.entities.length, $('.entityList > li.entityBlock').length);
            assert.equals(1, $('.entityList > li.someType').length);
            assert.equals(this.entities.length, $('.entityList li.remove-item').length);
            assert.equals(this.entities.length, $("li.remove-item form").length);
            assert.equals(0, $("li.remove-item form:visible").length);

            this.assertEventPublished();
        },

        assertEventPublished: function () {
            var call,
                eventData;

            assert(this.events.publish.calledOnce);
            call = this.events.publish.getCall(0);
            assert.equals(this.entityList.constants.get('PAGE_EVENT'), call.args[0]);

            eventData = call.args[1];
            assert.equals(15, eventData.nextOffset);
            assert.equals(5, eventData.prevOffset);
            assert.equals(10, eventData.offset);
            assert.equals(34, eventData.total);
        },

        stubRequestForAnnouncements: function () {
            var testCase = this;

            sinon.stub(jQuery, 'ajax', function (options) {
                options.success.call(null, {
                    list: {
                        actions: [
                            {
                                text: 'Remove',
                                link: 'someLink'
                            }
                        ],
                        entities: testCase.entities,
                        offset: 10,
                        limit: 5,
                        totalEntities: "34"
                    }
                });
            });
        }
    };
}()));